---
description: 睡眠记录功能 - 追踪宝宝的入睡和睡醒时间
globs:
  - "src/components/forms/SleepEndForm.tsx"
  - "src/app/page.tsx"
alwaysApply: false
---

# 睡眠记录

追踪宝宝的睡眠模式，包括入睡时间、睡醒时间和睡眠时长。

## Core Components

**数据模型（单条记录模式）:**
- `Activity` - type: `SLEEP`
- `recordTime` - 入睡时间
- `duration` - 睡眠时长（分钟）
  - `null` 表示正在睡觉
  - 有值表示睡眠已完成

**组件:**
- `SleepEndForm` - 睡醒表单，支持更新现有记录或手动输入时长
- `ActivityButton` - 入睡按钮
- `TimeAdjuster` - 时间滑块+微调组件
- `SliderInput` - 通用滑块输入组件（用于补录时长）

## How It Works

### 标准流程（先入睡后睡醒）
1. 用户点击"入睡"按钮
2. 创建 `SLEEP` 记录，`recordTime` = 入睡时间，`duration` = null
3. "入睡"按钮变为禁用状态（检测到 duration=null 的 SLEEP 记录）
4. 用户点击"睡醒"按钮
5. 系统找到 `duration` 为 null 的 `SLEEP` 记录
6. 自动计算睡眠时长（当前时间 - recordTime）
7. 显示睡眠时长，支持微调（-1小时/-15分/-5分/+1分）
8. **更新**现有 `SLEEP` 记录，设置 `duration` 值

### 补录流程（直接点睡醒）
1. 用户直接点击"睡醒"按钮（没有先点入睡）
2. `SleepEndForm` 显示时长滑块（15-240分钟，15分钟间隔）
3. 用户拖动滑块选择睡眠时长
4. 可用微调按钮细调（±15分钟/±75分钟）
5. **创建新的** `SLEEP` 记录，同时设置 `recordTime`（根据duration回推）和 `duration`

### 时间选择器（TimeAdjuster）
- **滑块**: 范围从"1小时前"到"现在"，5分钟间隔
- **微调按钮**: -1小时、-15分钟、-5分钟、+1分钟
- **不显示日期**: 只显示时间（HH:mm格式）
- 不允许超过当前时间

### 状态管理
- `useSleepState()` hook 返回：
  - `isSleeping` - 是否正在睡觉（有 duration=null 的 SLEEP 记录）
  - `sleepState` - `'start'` | `'end'`
  - `getCurrentSleepActivity()` - 获取当前正在进行的睡眠记录
- 当 `isSleeping = true` 时，"入睡"按钮 disabled

## Key Files
- `src/components/forms/SleepEndForm.tsx` - 睡醒表单组件
- `src/components/TimeAdjuster.tsx` - 时间滑块+微调组件
- `src/components/SliderInput.tsx` - 通用滑块输入组件
- `src/lib/api/hooks.ts` - useSleepState hook
- `src/app/page.tsx` - 主页面
- `prisma/schema.prisma` - Activity 模型定义

## UI 设计要点
- 字体加大：时间显示 `text-5xl`，时长显示 `text-5xl`
- 滑块范围：1小时前 ~ 现在，5分钟间隔
- 微调按钮：4列布局，颜色区分（减少=蓝色，增加=绿色）
- 补录时长：滑块输入（15-240分钟，15分钟间隔）

## 数据统计
- 统计 `SLEEP` 且 `duration !== null` 的记录
- 显示格式：时间范围 + 时长（如 "22:30 - 06:30 (8小时)"）
- 正在睡觉显示"正在睡觉..."带动画效果

## Future Improvements
- 睡眠质量评估（好/一般/差）
- 睡眠统计图表（每日/每周睡眠时长）
- 睡眠提醒（设定目标睡眠时长）
