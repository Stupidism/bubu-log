openapi: 3.1.0
info:
  title: Bubu Log API
  description: Baby activity tracking API
  version: 1.0.0

servers:
  - url: /api
    description: API server

paths:
  /activities:
    get:
      operationId: getActivities
      summary: Get activity list
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: type
          in: query
          schema:
            $ref: '#/components/schemas/ActivityType'
        - name: types
          in: query
          description: Comma-separated list of activity types to filter
          schema:
            type: string
        - name: date
          in: query
          description: Date in YYYY-MM-DD format
          schema:
            type: string
            format: date
        - name: includePreviousEvening
          in: query
          description: Include activities from previous evening (18:00+) for summary display
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Activity list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Activity'
        '500':
          $ref: '#/components/responses/ServerError'

    post:
      operationId: createActivity
      summary: Create new activity
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateActivityInput'
      responses:
        '201':
          description: Created activity
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Activity'
        '409':
          description: Time conflict with existing activity
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActivityConflictError'
        '500':
          $ref: '#/components/responses/ServerError'

    delete:
      operationId: batchDeleteActivities
      summary: Batch delete activities
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                ids:
                  type: array
                  items:
                    type: string
              required:
                - ids
      responses:
        '200':
          description: Deletion success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  count:
                    type: integer
        '500':
          $ref: '#/components/responses/ServerError'

    put:
      operationId: batchUpdateActivityDate
      summary: Batch update activity dates
      description: Move selected activities to a different date while preserving time of day
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                ids:
                  type: array
                  items:
                    type: string
                  description: Activity IDs to update
                targetDate:
                  type: string
                  format: date
                  description: Target date (YYYY-MM-DD format) to move activities to
              required:
                - ids
                - targetDate
      responses:
        '200':
          description: Update success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  count:
                    type: integer
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/ServerError'

  /activities/latest:
    get:
      operationId: getLatestActivity
      summary: Get latest activity by types
      parameters:
        - name: types
          in: query
          required: true
          description: Comma-separated list of activity types
          schema:
            type: string
      responses:
        '200':
          description: Latest activity (null if not found)
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/Activity'
                  - type: 'null'
        '400':
          description: Bad request - types parameter required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/ServerError'

  /activities/{id}:
    get:
      operationId: getActivity
      summary: Get single activity
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Activity details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Activity'
        '404':
          description: Activity not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/ServerError'

    patch:
      operationId: updateActivity
      summary: Update activity
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateActivityInput'
      responses:
        '200':
          description: Updated activity
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Activity'
        '500':
          $ref: '#/components/responses/ServerError'

    delete:
      operationId: deleteActivity
      summary: Delete activity
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Deletion success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '500':
          $ref: '#/components/responses/ServerError'

  /activities/upload-photo:
    post:
      operationId: uploadActivityPhoto
      summary: Upload activity photo
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                category:
                  type: string
              required:
                - file
      responses:
        '200':
          description: Upload success
          content:
            application/json:
              schema:
                type: object
                properties:
                  url:
                    type: string
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/ServerError'

    delete:
      operationId: deleteActivityPhoto
      summary: Delete activity photo
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                url:
                  type: string
              required:
                - url
      responses:
        '200':
          description: Deletion success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '500':
          $ref: '#/components/responses/ServerError'

  /voice-input:
    post:
      operationId: parseVoiceInput
      summary: Parse voice input and create activity
      description: |
        Accepts natural language text (from voice input) and uses AI to parse it into a structured activity record.
        Supports Chinese input like "宝宝喝了80毫升奶" or "刚换了尿布，有便便".
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                text:
                  type: string
                  description: The voice input text to parse
                  example: "宝宝刚才喝了60毫升奶"
              required:
                - text
      responses:
        '201':
          description: Activity created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  activity:
                    $ref: '#/components/schemas/Activity'
                  parsed:
                    type: object
                    properties:
                      confidence:
                        type: number
                        description: AI confidence level (0-1)
                      originalText:
                        type: string
                  message:
                    type: string
                    description: Human-readable confirmation message
        '400':
          description: Parse failed or invalid input
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  code:
                    type: string
                    enum: [MISSING_TEXT, PARSE_FAILED, INVALID_TYPE]
                  originalText:
                    type: string
        '500':
          $ref: '#/components/responses/ServerError'

  /audits:
    get:
      operationId: getAudits
      summary: Get audit logs
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
        - name: action
          in: query
          description: Filter by action type
          schema:
            $ref: '#/components/schemas/AuditAction'
        - name: resourceType
          in: query
          description: Filter by resource type
          schema:
            $ref: '#/components/schemas/ResourceType'
        - name: success
          in: query
          description: Filter by success status
          schema:
            type: boolean
      responses:
        '200':
          description: Audit log list with pagination info
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/AuditLog'
                  total:
                    type: integer
                  hasMore:
                    type: boolean
        '500':
          $ref: '#/components/responses/ServerError'

  /baby-profile:
    get:
      operationId: getBabyProfile
      summary: Get baby profile
      responses:
        '200':
          description: Baby profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BabyProfile'
        '500':
          $ref: '#/components/responses/ServerError'

    patch:
      operationId: updateBabyProfile
      summary: Update baby profile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateBabyProfileInput'
      responses:
        '200':
          description: Updated baby profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BabyProfile'
        '500':
          $ref: '#/components/responses/ServerError'

  /baby-profile/avatar:
    post:
      operationId: uploadAvatar
      summary: Upload baby avatar
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
              required:
                - file
      responses:
        '200':
          description: Upload success
          content:
            application/json:
              schema:
                type: object
                properties:
                  url:
                    type: string
                  profile:
                    $ref: '#/components/schemas/BabyProfile'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/ServerError'

    delete:
      operationId: deleteAvatar
      summary: Delete baby avatar
      responses:
        '200':
          description: Deletion success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '500':
          $ref: '#/components/responses/ServerError'

  /daily-stats:
    get:
      operationId: getDailyStats
      summary: Get daily statistics list
      description: Get daily statistics within a date range
      parameters:
        - name: startDate
          in: query
          description: Start date (YYYY-MM-DD format)
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          description: End date (YYYY-MM-DD format)
          schema:
            type: string
            format: date
        - name: limit
          in: query
          description: Maximum number of records to return
          schema:
            type: integer
            default: 30
      responses:
        '200':
          description: Daily statistics list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DailyStat'
        '500':
          $ref: '#/components/responses/ServerError'

    post:
      operationId: computeDailyStat
      summary: Compute and store daily statistics
      description: Compute statistics for a specific date and store in database
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                date:
                  type: string
                  format: date
                  description: Date to compute statistics for (YYYY-MM-DD format)
              required:
                - date
      responses:
        '200':
          description: Computed daily statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DailyStat'
        '400':
          description: Bad request - date is required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/ServerError'

  /daily-stats/{date}:
    get:
      operationId: getDailyStat
      summary: Get daily statistics for a specific date
      parameters:
        - name: date
          in: path
          required: true
          description: Date in YYYY-MM-DD format
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Daily statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DailyStat'
        '400':
          description: Invalid date format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Statistics not found for this date
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/ServerError'

components:
  schemas:
    ActivityType:
      type: string
      enum:
        - SLEEP
        - DIAPER
        - BREASTFEED
        - BOTTLE
        - HEAD_LIFT
        - PASSIVE_EXERCISE
        - GAS_EXERCISE
        - BATH
        - OUTDOOR
        - EARLY_EDUCATION
        - SUPPLEMENT

    PoopColor:
      type: string
      enum:
        - YELLOW
        - GREEN
        - BROWN
        - BLACK
        - WHITE
        - RED

    PeeAmount:
      type: string
      enum:
        - SMALL
        - MEDIUM
        - LARGE

    BreastFirmness:
      type: string
      enum:
        - SOFT    # 软
        - ELASTIC # 弹
        - HARD    # 硬

    SupplementType:
      type: string
      enum:
        - AD    # 维生素AD
        - D3    # 维生素D3

    InputMethod:
      type: string
      enum:
        - TEXT   # 文字输入
        - VOICE  # 语音输入

    AuditAction:
      type: string
      enum:
        - CREATE  # 创建
        - UPDATE  # 修改
        - DELETE  # 删除

    ResourceType:
      type: string
      enum:
        - ACTIVITY  # 活动记录

    AuditLog:
      type: object
      required:
        - id
        - action
        - resourceType
        - inputMethod
        - success
        - createdAt
      properties:
        id:
          type: string
        action:
          $ref: '#/components/schemas/AuditAction'
        resourceType:
          $ref: '#/components/schemas/ResourceType'
        resourceId:
          type: string
          nullable: true
          description: 资源ID
        inputMethod:
          $ref: '#/components/schemas/InputMethod'
        inputText:
          type: string
          nullable: true
          description: 原始输入内容（语音输入）
        description:
          type: string
          nullable: true
          description: 简短描述
        success:
          type: boolean
          description: 是否成功
        errorMessage:
          type: string
          nullable: true
          description: 错误信息
        beforeData:
          type: object
          nullable: true
          description: 修改前的资源内容
        afterData:
          type: object
          nullable: true
          description: 修改后的资源内容
        activityId:
          type: string
          nullable: true
          description: 关联的活动ID
        createdAt:
          type: string
          format: date-time
          description: 操作时间

    Activity:
      type: object
      required:
        - id
        - type
        - startTime
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
        type:
          $ref: '#/components/schemas/ActivityType'
        startTime:
          type: string
          format: date-time
          description: 活动开始时间
        endTime:
          type: string
          format: date-time
          nullable: true
          description: 活动结束时间（正在进行的活动没有结束时间）
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        hasPoop:
          type: boolean
          nullable: true
        hasPee:
          type: boolean
          nullable: true
        poopColor:
          $ref: '#/components/schemas/PoopColor'
        poopPhotoUrl:
          type: string
          nullable: true
        peeAmount:
          $ref: '#/components/schemas/PeeAmount'
        burpSuccess:
          type: boolean
          nullable: true
        milkAmount:
          type: integer
          nullable: true
        breastFirmness:
          $ref: '#/components/schemas/BreastFirmness'
          nullable: true
        supplementType:
          $ref: '#/components/schemas/SupplementType'
          nullable: true
        notes:
          type: string
          nullable: true

    CreateActivityInput:
      type: object
      required:
        - type
        - startTime
      properties:
        type:
          $ref: '#/components/schemas/ActivityType'
        startTime:
          type: string
          format: date-time
          description: 活动开始时间
        endTime:
          type: string
          format: date-time
          description: 活动结束时间（可选）
        hasPoop:
          type: boolean
        hasPee:
          type: boolean
        poopColor:
          $ref: '#/components/schemas/PoopColor'
        poopPhotoUrl:
          type: string
        peeAmount:
          $ref: '#/components/schemas/PeeAmount'
        burpSuccess:
          type: boolean
        milkAmount:
          type: integer
        breastFirmness:
          $ref: '#/components/schemas/BreastFirmness'
        supplementType:
          $ref: '#/components/schemas/SupplementType'
        notes:
          type: string
        force:
          type: boolean
          description: Force create even if there's an overlap warning (not for duplicates)

    UpdateActivityInput:
      type: object
      properties:
        type:
          $ref: '#/components/schemas/ActivityType'
        startTime:
          type: string
          format: date-time
          description: 活动开始时间
        endTime:
          type: string
          format: date-time
          description: 活动结束时间
        hasPoop:
          type: boolean
        hasPee:
          type: boolean
        poopColor:
          $ref: '#/components/schemas/PoopColor'
        poopPhotoUrl:
          type: string
        peeAmount:
          $ref: '#/components/schemas/PeeAmount'
        burpSuccess:
          type: boolean
        milkAmount:
          type: integer
        breastFirmness:
          $ref: '#/components/schemas/BreastFirmness'
        supplementType:
          $ref: '#/components/schemas/SupplementType'
        notes:
          type: string

    BabyProfile:
      type: object
      required:
        - id
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
        name:
          type: string
          nullable: true
        avatarUrl:
          type: string
          nullable: true
        birthDate:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    UpdateBabyProfileInput:
      type: object
      properties:
        name:
          type: string
        avatarUrl:
          type: string
        birthDate:
          type: string
          format: date-time

    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: string

    ActivityConflictError:
      type: object
      required:
        - error
        - code
      properties:
        error:
          type: string
          description: Human-readable error message
        code:
          type: string
          enum:
            - DUPLICATE_ACTIVITY
            - OVERLAP_ACTIVITY
          description: |
            DUPLICATE_ACTIVITY - Same type activity exists at same time (cannot be overridden)
            OVERLAP_ACTIVITY - Time overlaps with another activity (can be overridden with force=true)
        conflictingActivity:
          $ref: '#/components/schemas/Activity'

    DailyStat:
      type: object
      required:
        - id
        - date
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
        date:
          type: string
          format: date-time
          description: 统计日期
        sleepCount:
          type: integer
          description: 睡眠次数
        totalSleepMinutes:
          type: integer
          description: 总睡眠时长（分钟）
        breastfeedCount:
          type: integer
          description: 亲喂次数
        totalBreastfeedMinutes:
          type: integer
          description: 亲喂总时长（分钟）
        bottleCount:
          type: integer
          description: 瓶喂次数
        totalMilkAmount:
          type: integer
          description: 瓶喂总奶量（毫升）
        diaperCount:
          type: integer
          description: 换尿布次数
        poopCount:
          type: integer
          description: 大便次数
        peeCount:
          type: integer
          description: 小便次数
        exerciseCount:
          type: integer
          description: 活动次数
        totalHeadLiftMinutes:
          type: integer
          description: 抬头总时长（分钟）
        supplementADCount:
          type: integer
          description: AD补剂次数
        supplementD3Count:
          type: integer
          description: D3补剂次数
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

  responses:
    ServerError:
      description: Server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
