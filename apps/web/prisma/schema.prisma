// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

// 活动类型枚举
enum ActivityType {
  SLEEP            // 睡眠（startTime=入睡时间，endTime=睡醒时间，endTime为null表示正在睡）
  DIAPER           // 换尿布（只有startTime）
  BREASTFEED       // 亲喂（startTime=开始时间，endTime=结束时间）
  BOTTLE           // 瓶喂（startTime=开始时间，endTime=结束时间，milkAmount=奶量）
  HEAD_LIFT        // 抬头
  PASSIVE_EXERCISE // 被动操
  GAS_EXERCISE     // 排气操
  BATH             // 洗澡
  OUTDOOR          // 户外晒太阳
  EARLY_EDUCATION  // 早教
  SUPPLEMENT       // 补剂（AD或D3）
}

// 补剂类型枚举
enum SupplementType {
  AD    // AD（维生素AD）
  D3    // D3（维生素D3）
}

// 大便颜色枚举
enum PoopColor {
  YELLOW       // 黄色
  GREEN        // 绿色
  BROWN        // 棕色
  BLACK        // 黑色
  WHITE        // 白色
  RED          // 红色（需要注意）
}

// 小便量枚举
enum PeeAmount {
  SMALL   // 少
  MEDIUM  // 中
  LARGE   // 多
}

// 乳房硬度枚举（亲喂后）
enum BreastFirmness {
  SOFT    // 软
  ELASTIC // 弹
  HARD    // 硬
}

// 宝宝资料模型（单例，只存储一个宝宝的信息）
model BabyProfile {
  id        String   @id @default("default")
  name      String?  // 宝宝名字
  avatarUrl String?  // 头像URL（存储在Vercel Blob）
  birthDate DateTime? // 出生日期
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 活动记录模型
model Activity {
  id              String       @id @default(cuid())
  type            ActivityType
  startTime       DateTime     @default(now()) // 活动开始时间
  endTime         DateTime?    // 活动结束时间（可选，正在进行的活动没有结束时间）
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // 尿布相关字段
  hasPoop         Boolean?     // 是否有大便
  hasPee          Boolean?     // 是否有小便
  poopColor       PoopColor?   // 大便颜色
  poopPhotoUrl    String?      // 大便照片URL（存储在Vercel Blob）
  peeAmount       PeeAmount?   // 小便量

  // 喂奶相关字段
  burpSuccess     Boolean?     // 拍嗝是否成功
  milkAmount      Int?         // 奶量（毫升）- 瓶喂专用
  breastFirmness  BreastFirmness? // 乳房硬度（亲喂后）- 软、弹、硬

  // 补剂相关字段
  supplementType  SupplementType? // 补剂类型（AD或D3）

  // 备注
  notes           String?

  // 审计日志关联
  auditLogs       AuditLog[]

  @@index([type])
  @@index([startTime])
  @@index([createdAt])
}

// 输入方式枚举
enum InputMethod {
  TEXT   // 文字输入
  VOICE  // 语音输入
}

// 操作类型枚举
enum AuditAction {
  CREATE  // 创建
  UPDATE  // 修改
  DELETE  // 删除
}

// 资源类型枚举
enum ResourceType {
  ACTIVITY  // 活动记录
}

// 每日统计模型 - 存储每天的汇总数据
model DailyStat {
  id                    String   @id @default(cuid())
  date                  DateTime @unique // 统计日期（只存储日期部分，时间为00:00:00）
  
  // 睡眠统计
  sleepCount            Int      @default(0) // 睡眠次数
  totalSleepMinutes     Int      @default(0) // 总睡眠时长（分钟）
  
  // 喂奶统计
  breastfeedCount       Int      @default(0) // 亲喂次数
  totalBreastfeedMinutes Int     @default(0) // 亲喂总时长（分钟）
  bottleCount           Int      @default(0) // 瓶喂次数
  totalMilkAmount       Int      @default(0) // 瓶喂总奶量（毫升）
  
  // 尿布统计
  diaperCount           Int      @default(0) // 换尿布次数
  poopCount             Int      @default(0) // 大便次数
  peeCount              Int      @default(0) // 小便次数
  
  // 活动统计
  exerciseCount         Int      @default(0) // 活动次数
  totalHeadLiftMinutes  Int      @default(0) // 抬头总时长（分钟）
  
  // 补剂统计
  supplementADCount     Int      @default(0) // AD补剂次数
  supplementD3Count     Int      @default(0) // D3补剂次数
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([date])
}

// 审计日志模型 - 记录用户的操作历史
model AuditLog {
  id             String        @id @default(cuid())
  action         AuditAction   @default(CREATE) // 操作类型
  resourceType   ResourceType  @default(ACTIVITY) // 资源类型
  resourceId     String?       // 资源ID（删除后可能为空）
  inputMethod    InputMethod   // 输入方式
  inputText      String?       // 原始输入内容（语音转文字后的内容）
  description    String?       // 简短描述
  success        Boolean       @default(true) // 是否成功
  errorMessage   String?       // 错误信息（失败时记录）
  beforeData     Json?         // 修改前的资源内容
  afterData      Json?         // 修改后的资源内容
  activityId     String?       // 关联的活动ID（可选）
  activity       Activity?     @relation(fields: [activityId], references: [id], onDelete: SetNull)
  createdAt      DateTime      @default(now()) // 操作时间
  
  @@index([createdAt])
  @@index([action])
  @@index([resourceType])
  @@index([success])
}
