// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

// ==================== 认证相关模型 ====================

// NextAuth.js 账户模型
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

// NextAuth.js Session 模型
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// NextAuth.js 验证令牌模型
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// 用户角色枚举
enum UserRole {
  DAD           // 爸爸
  MOM           // 妈妈
  NANNY         // 月嫂
  GRANDPARENT   // 祖父母/外祖父母
  OTHER         // 其他
}

// 用户模型（爸爸、妈妈、月嫂等）
model User {
  id            String    @id @default(cuid())
  name          String?   // 用户名称
  email         String?   @unique
  emailVerified DateTime?
  image         String?   // 头像URL
  role          UserRole  @default(OTHER) // 用户角色
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // NextAuth 关联
  accounts      Account[]
  sessions      Session[]

  // 关联的宝宝（多对多）
  babies        BabyUser[]
  
  // 审计日志
  auditLogs     AuditLog[]

  @@index([email])
}

// ==================== 宝宝相关模型 ====================

// 宝宝模型（核心资源，类似租户）
model Baby {
  id        String   @id @default(cuid())
  name      String   // 宝宝名字
  avatarUrl String?  // 头像URL（存储在Vercel Blob）
  birthDate DateTime? // 出生日期
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联的用户（多对多）
  users       BabyUser[]
  
  // 关联的数据
  activities  Activity[]
  dailyStats  DailyStat[]
  auditLogs   AuditLog[]

  @@index([name])
}

// 宝宝-用户关联表（多对多）
model BabyUser {
  id        String   @id @default(cuid())
  babyId    String
  userId    String
  isDefault Boolean  @default(false) // 是否为用户的默认宝宝
  createdAt DateTime @default(now())

  baby      Baby     @relation(fields: [babyId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([babyId, userId])
  @@index([babyId])
  @@index([userId])
}

// ==================== 活动相关枚举 ====================

// 活动类型枚举
enum ActivityType {
  SLEEP            // 睡眠（startTime=入睡时间，endTime=睡醒时间，endTime为null表示正在睡）
  DIAPER           // 换尿布（只有startTime）
  BREASTFEED       // 亲喂（startTime=开始时间，endTime=结束时间）
  BOTTLE           // 瓶喂（startTime=开始时间，endTime=结束时间，milkAmount=奶量）
  HEAD_LIFT        // 抬头
  PASSIVE_EXERCISE // 被动操
  GAS_EXERCISE     // 排气操
  BATH             // 洗澡
  OUTDOOR          // 户外晒太阳
  EARLY_EDUCATION  // 早教
  SUPPLEMENT       // 补剂（AD或D3）
}

// 补剂类型枚举
enum SupplementType {
  AD    // AD（维生素AD）
  D3    // D3（维生素D3）
}

// 大便颜色枚举
enum PoopColor {
  YELLOW       // 黄色
  GREEN        // 绿色
  BROWN        // 棕色
  BLACK        // 黑色
  WHITE        // 白色
  RED          // 红色（需要注意）
}

// 小便量枚举
enum PeeAmount {
  SMALL   // 少
  MEDIUM  // 中
  LARGE   // 多
}

// 乳房硬度枚举（亲喂后）
enum BreastFirmness {
  SOFT    // 软
  ELASTIC // 弹
  HARD    // 硬
}

// ==================== 活动记录模型 ====================

// 活动记录模型
model Activity {
  id              String       @id @default(cuid())
  type            ActivityType
  startTime       DateTime     @default(now()) // 活动开始时间
  endTime         DateTime?    // 活动结束时间（可选，正在进行的活动没有结束时间）
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // 关联的宝宝
  babyId          String
  baby            Baby         @relation(fields: [babyId], references: [id], onDelete: Cascade)

  // 尿布相关字段
  hasPoop         Boolean?     // 是否有大便
  hasPee          Boolean?     // 是否有小便
  poopColor       PoopColor?   // 大便颜色
  poopPhotoUrl    String?      // 大便照片URL（存储在Vercel Blob）
  peeAmount       PeeAmount?   // 小便量

  // 喂奶相关字段
  burpSuccess     Boolean?     // 拍嗝是否成功
  milkAmount      Int?         // 奶量（毫升）- 瓶喂专用
  breastFirmness  BreastFirmness? // 乳房硬度（亲喂后）- 软、弹、硬

  // 补剂相关字段
  supplementType  SupplementType? // 补剂类型（AD或D3）

  // 备注
  notes           String?

  // 审计日志关联
  auditLogs       AuditLog[]

  @@index([babyId])
  @@index([type])
  @@index([startTime])
  @@index([createdAt])
}

// ==================== 统计相关模型 ====================

// 输入方式枚举
enum InputMethod {
  TEXT   // 文字输入
  VOICE  // 语音输入
}

// 操作类型枚举
enum AuditAction {
  CREATE  // 创建
  UPDATE  // 修改
  DELETE  // 删除
}

// 资源类型枚举
enum ResourceType {
  ACTIVITY  // 活动记录
}

// 每日统计模型 - 存储每天的汇总数据
model DailyStat {
  id                    String   @id @default(cuid())
  date                  DateTime // 统计日期（只存储日期部分，时间为00:00:00）
  
  // 关联的宝宝
  babyId                String
  baby                  Baby     @relation(fields: [babyId], references: [id], onDelete: Cascade)
  
  // 睡眠统计
  sleepCount            Int      @default(0) // 睡眠次数
  totalSleepMinutes     Int      @default(0) // 总睡眠时长（分钟）
  
  // 喂奶统计
  breastfeedCount       Int      @default(0) // 亲喂次数
  totalBreastfeedMinutes Int     @default(0) // 亲喂总时长（分钟）
  bottleCount           Int      @default(0) // 瓶喂次数
  totalMilkAmount       Int      @default(0) // 瓶喂总奶量（毫升）
  
  // 尿布统计
  diaperCount           Int      @default(0) // 换尿布次数
  poopCount             Int      @default(0) // 大便次数
  peeCount              Int      @default(0) // 小便次数
  
  // 活动统计
  exerciseCount         Int      @default(0) // 活动次数
  totalHeadLiftMinutes  Int      @default(0) // 抬头总时长（分钟）
  
  // 补剂统计
  supplementADCount     Int      @default(0) // AD补剂次数
  supplementD3Count     Int      @default(0) // D3补剂次数
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@unique([babyId, date])
  @@index([babyId])
  @@index([date])
}

// 保留旧的 BabyProfile 表用于迁移（之后可删除）
model BabyProfile {
  id        String   @id @default("default")
  name      String?  // 宝宝名字
  avatarUrl String?  // 头像URL（存储在Vercel Blob）
  birthDate DateTime? // 出生日期
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 审计日志模型 - 记录用户的操作历史
model AuditLog {
  id             String        @id @default(cuid())
  action         AuditAction   @default(CREATE) // 操作类型
  resourceType   ResourceType  @default(ACTIVITY) // 资源类型
  resourceId     String?       // 资源ID（删除后可能为空）
  inputMethod    InputMethod   // 输入方式
  inputText      String?       // 原始输入内容（语音转文字后的内容）
  description    String?       // 简短描述
  success        Boolean       @default(true) // 是否成功
  errorMessage   String?       // 错误信息（失败时记录）
  beforeData     Json?         // 修改前的资源内容
  afterData      Json?         // 修改后的资源内容
  
  // 关联的宝宝
  babyId         String?
  baby           Baby?         @relation(fields: [babyId], references: [id], onDelete: SetNull)
  
  // 关联的活动
  activityId     String?
  activity       Activity?     @relation(fields: [activityId], references: [id], onDelete: SetNull)
  
  // 操作用户
  userId         String?
  user           User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  createdAt      DateTime      @default(now()) // 操作时间
  
  @@index([babyId])
  @@index([userId])
  @@index([createdAt])
  @@index([action])
  @@index([resourceType])
  @@index([success])
}
